<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Highland Fresh - Bulk Inventory Update</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link href="../css/styles.css" rel="stylesheet">
    <style>
        :root {
            --hf-primary: #198754;
            --hf-secondary: #20c997;
        }

        .highland-fresh-card {
            border-left: 4px solid var(--hf-primary);
            transition: all 0.3s ease;
        }

        .highland-fresh-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .cooperative-badge {
            background: linear-gradient(45deg, var(--hf-primary), var(--hf-secondary));
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .bulk-update-table th {
            background: var(--hf-primary);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .table-container {
            max-height: 500px;
            overflow-y: auto;
        }

        .quantity-input {
            min-width: 120px;
        }

        .btn-cooperative {
            background: linear-gradient(45deg, var(--hf-primary), var(--hf-secondary));
            border: none;
            color: white;
        }

        .btn-cooperative:hover {
            background: linear-gradient(45deg, var(--hf-secondary), var(--hf-primary));
            color: white;
        }
    </style>
</head>

<body class="bg-light">
    <!-- Loading Overlay -->
    <div id="loading-indicator" class="loading-overlay" style="display: none;">
        <div class="text-center">
            <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-3 text-success fw-bold">Processing Bulk Update...</div>
        </div>
    </div>

    <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: var(--hf-primary);">
        <div class="container-fluid">
            <a class="navbar-brand" href="../html/warehouse-staff-dashboard.html">
                <i class="bi bi-box-seam me-2"></i>Highland Fresh - Bulk Inventory Update
            </a>

            <div class="navbar-nav ms-auto d-flex align-items-center">
                <span class="navbar-text me-3" id="userWelcome">
                    <i class="bi bi-person-circle me-1"></i>Welcome, <span id="currentUser">User</span>!
                </span>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">
                    <i class="bi bi-box-arrow-right me-1"></i>Logout
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Alert Container -->
        <div id="alert-container"></div>

        <!-- Header Row -->
        <div class="row mb-4">
            <div class="col-md-8">
                <h2 class="mb-0">
                    <i class="bi bi-boxes text-success me-2"></i>
                    Bulk Inventory Update
                </h2>
                <p class="text-muted">Update multiple Highland Fresh products simultaneously</p>
            </div>
            <div class="col-md-4">
                <div class="d-flex gap-2 justify-content-end">
                    <button id="import-csv" class="btn btn-outline-success btn-sm">
                        <i class="bi bi-upload me-1"></i>Import CSV
                    </button>
                    <button id="export-template" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-download me-1"></i>Export Template
                    </button>
                    <button id="refresh-products" class="btn btn-success btn-sm">
                        <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                    </button>
                </div>
            </div>
        </div>

        <!-- Filters Row -->
        <div class="row mb-4">
            <div class="col-lg-12">
                <div class="card highland-fresh-card">
                    <div class="card-header bg-light">
                        <h6 class="card-title mb-0">
                            <i class="bi bi-funnel me-2"></i>Filters & Actions
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-end">
                            <div class="col-md-3">
                                <label for="cooperative-filter" class="form-label">Cooperative</label>
                                <select id="cooperative-filter" class="form-select form-select-sm">
                                    <option value="">All Cooperatives</option>
                                    <option value="Dalwangan Dairy Cooperative">Dalwangan Dairy</option>
                                    <option value="Bukidnon Dairy Cooperative">Bukidnon Dairy</option>
                                    <option value="Misamis Oriental Dairy Cooperative">Misamis Oriental</option>
                                    <option value="Malaybalay Cheese Artisans">Malaybalay Cheese</option>
                                    <option value="Cagayan de Oro Dairy Alliance">CDO Dairy Alliance</option>
                                    <option value="Iligan Dairy Cooperative">Iligan Dairy</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="category-filter" class="form-label">Category</label>
                                <select id="category-filter" class="form-select form-select-sm">
                                    <option value="">All Categories</option>
                                    <!-- Categories will be loaded dynamically -->
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="stock-status-filter" class="form-label">Stock Status</label>
                                <select id="stock-status-filter" class="form-select form-select-sm">
                                    <option value="">All Status</option>
                                    <option value="In Stock">In Stock</option>
                                    <option value="Low Stock">Low Stock</option>
                                    <option value="Out of Stock">Out of Stock</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="reason-bulk" class="form-label">Update Reason</label>
                                <select id="reason-bulk" class="form-select form-select-sm">
                                    <option value="Bulk Update">Bulk Update</option>
                                    <option value="Count Adjustment">Count Adjustment</option>
                                    <option value="Stock Receipt">Stock Receipt</option>
                                    <option value="Damage">Damage</option>
                                    <option value="Return">Return</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button id="select-all" class="btn btn-outline-success btn-sm me-2">
                                    <i class="bi bi-check-all me-1"></i>Select All
                                </button>
                                <button id="clear-all" class="btn btn-outline-secondary btn-sm me-2">
                                    <i class="bi bi-x-square me-1"></i>Clear All
                                </button>
                                <button id="update-selected" class="btn btn-cooperative btn-sm">
                                    <i class="bi bi-arrow-up-circle me-1"></i>Update Selected
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Products Table -->
        <div class="row">
            <div class="col-lg-12">
                <div class="card highland-fresh-card">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-table me-2"></i>Highland Fresh Products
                        </h5>
                        <span id="selected-count" class="badge bg-light text-dark">0 selected</span>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-container">
                            <div id="products-table">
                                <div class="text-center py-4">
                                    <div class="spinner-border text-success" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2 text-muted">Loading Highland Fresh products...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CSV Import Modal -->
    <div class="modal fade" id="csvImportModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-upload me-2"></i>Import CSV File
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>CSV Format:</strong> Your CSV file should have columns: product_id, new_quantity, reason
                    </div>

                    <div class="mb-3">
                        <label for="csv-file" class="form-label">Select CSV File</label>
                        <input type="file" class="form-control" id="csv-file" accept=".csv">
                    </div>

                    <div id="csv-preview" class="mt-3" style="display: none;">
                        <h6>Preview:</h6>
                        <div class="table-responsive">
                            <table class="table table-sm" id="csv-preview-table">
                                <!-- CSV preview will be shown here -->
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="process-csv" disabled>
                        <i class="bi bi-check-lg me-1"></i>Process Import
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden file input for CSV import -->
    <input type="file" id="hidden-csv-input" accept=".csv" style="display: none;">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script src="../js/api-handler.js"></script>
    <script src="../js/user-display-utils.js"></script>
    <script src="../js/session-manager.js"></script>
    <script src="../js/auth.js"></script>

    <script>
        // Bulk Inventory Update Manager
        class BulkInventoryManager {
            constructor() {
                this.products = [];
                this.selectedProducts = new Set();
            }

            async init() {
                this.setupEventListeners();
                await this.loadProducts();
                // Categories not needed for this page
            }

            setupEventListeners() {
                // Filter event listeners
                document.getElementById('cooperative-filter').addEventListener('change', () => this.filterProducts());
                document.getElementById('category-filter').addEventListener('change', () => this.filterProducts());
                document.getElementById('stock-status-filter').addEventListener('change', () => this.filterProducts());

                // Action buttons
                document.getElementById('refresh-products').addEventListener('click', () => this.loadProducts());
                document.getElementById('select-all').addEventListener('click', () => this.selectAll());
                document.getElementById('clear-all').addEventListener('click', () => this.clearAll());
                document.getElementById('update-selected').addEventListener('click', () => this.updateSelected());
                document.getElementById('export-template').addEventListener('click', () => this.exportTemplate());
                document.getElementById('import-csv').addEventListener('click', () => this.showImportModal());

                // CSV import
                document.getElementById('csv-file').addEventListener('change', (e) => this.previewCSV(e));
                document.getElementById('process-csv').addEventListener('click', () => this.processCSVImport());
            }

            async loadProducts() {
                try {
                    const response = await fetch('../api/InventoryAPI.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ operation: 'getStockStatus' })
                    });

                    const result = await response.json();

                    if (result.success) {
                        this.products = result.data;
                        this.renderProductsTable();
                    } else {
                        throw new Error(result.message);
                    }
                } catch (error) {
                    console.error('Error loading products:', error);
                    this.showAlert('Error loading products: ' + error.message, 'danger');
                }
            }

            async loadCategories() {
                try {
                    const response = await fetch('../api/CategoryAPI.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ operation: 'getCategories' })
                    });

                    const result = await response.json();

                    if (result.success) {
                        const categorySelect = document.getElementById('category-filter');
                        result.data.forEach(category => {
                            const option = document.createElement('option');
                            option.value = category.category_name;
                            option.textContent = category.category_name;
                            categorySelect.appendChild(option);
                        });
                    }
                } catch (error) {
                    console.error('Error loading categories:', error);
                }
            }

            renderProductsTable() {
                const tableContainer = document.getElementById('products-table');

                if (this.products.length === 0) {
                    tableContainer.innerHTML = `
                        <div class="text-center py-4">
                            <i class="bi bi-box text-muted" style="font-size: 3rem;"></i>
                            <p class="mt-2 text-muted">No products found</p>
                        </div>
                    `;
                    return;
                }

                const table = `
                    <table class="table table-hover bulk-update-table mb-0">
                        <thead>
                            <tr>
                                <th width="50">
                                    <input type="checkbox" id="select-all-checkbox" onchange="bulkManager.toggleSelectAll(this.checked)">
                                </th>
                                <th width="120">SKU</th>
                                <th>Product Name</th>
                                <th width="150">Cooperative</th>
                                <th width="100">Current Stock</th>
                                <th width="120">New Quantity</th>
                                <th width="100">Status</th>
                                <th width="100">Days to Expiry</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${this.products.map(product => `
                                <tr>
                                    <td>
                                        <input type="checkbox" 
                                               value="${product.product_id}" 
                                               onchange="bulkManager.toggleProduct(${product.product_id}, this.checked)">
                                    </td>
                                    <td><small class="text-muted">${product.sku}</small></td>
                                    <td>
                                        <div>
                                            <strong>${product.name}</strong>
                                            ${product.batch_lot_number ? `<br><small class="text-muted">Batch: ${product.batch_lot_number}</small>` : ''}
                                        </div>
                                    </td>
                                    <td>
                                        ${product.milk_source_cooperative ?
                        `<span class="badge cooperative-badge text-white small">${product.milk_source_cooperative}</span>` :
                        '<span class="text-muted">N/A</span>'}
                                    </td>
                                    <td>
                                        <strong>${product.quantity_on_hand}</strong> ${product.unit_name || ''}
                                        <br><small class="text-muted">Reorder: ${product.reorder_level}</small>
                                    </td>
                                    <td>
                                        <input type="number" 
                                               class="form-control form-control-sm quantity-input" 
                                               id="qty_${product.product_id}"
                                               value="${product.quantity_on_hand}" 
                                               step="0.001" 
                                               min="0">
                                    </td>
                                    <td>
                                        <span class="badge bg-${this.getStatusBadgeClass(product.stock_status)}">${product.stock_status}</span>
                                    </td>
                                    <td>
                                        ${product.days_to_expiry !== null ?
                        (product.days_to_expiry < 0 ?
                            `<span class="badge bg-danger fw-bold">⚠️ EXPIRED (${Math.abs(product.days_to_expiry)} days ago)</span>` :
                            `<span class="badge bg-${product.days_to_expiry <= 3 ? 'danger' : product.days_to_expiry <= 7 ? 'warning' : 'success'}">${product.days_to_expiry} days</span>`) :
                        '<span class="text-muted">N/A</span>'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;

                tableContainer.innerHTML = table;
                this.updateSelectedCount();
            }

            getStatusBadgeClass(status) {
                const statusClasses = {
                    'In Stock': 'success',
                    'Low Stock': 'warning',
                    'Out of Stock': 'danger'
                };
                return statusClasses[status] || 'secondary';
            }

            toggleSelectAll(checked) {
                const checkboxes = document.querySelectorAll('input[type="checkbox"][value]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = checked;
                    this.toggleProduct(parseInt(checkbox.value), checked);
                });
            }

            toggleProduct(productId, checked) {
                if (checked) {
                    this.selectedProducts.add(productId);
                } else {
                    this.selectedProducts.delete(productId);
                }
                this.updateSelectedCount();
            }

            selectAll() {
                const checkboxes = document.querySelectorAll('input[type="checkbox"][value]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = true;
                    this.selectedProducts.add(parseInt(checkbox.value));
                });
                document.getElementById('select-all-checkbox').checked = true;
                this.updateSelectedCount();
            }

            clearAll() {
                const checkboxes = document.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(checkbox => checkbox.checked = false);
                this.selectedProducts.clear();
                this.updateSelectedCount();
            }

            updateSelectedCount() {
                document.getElementById('selected-count').textContent = `${this.selectedProducts.size} selected`;
            }

            async updateSelected() {
                if (this.selectedProducts.size === 0) {
                    this.showAlert('Please select products to update', 'warning');
                    return;
                }

                const updates = [];
                const reason = document.getElementById('reason-bulk').value;

                for (const productId of this.selectedProducts) {
                    const quantityInput = document.getElementById(`qty_${productId}`);
                    if (quantityInput) {
                        updates.push({
                            product_id: productId,
                            quantity: parseFloat(quantityInput.value),
                            reason: reason
                        });
                    }
                }

                if (updates.length === 0) {
                    this.showAlert('No valid updates found', 'warning');
                    return;
                }

                this.showLoadingOverlay();

                try {
                    const response = await fetch('../api/InventoryAPI.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            operation: 'bulkUpdateInventory',
                            updates: updates
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        this.showAlert(`Successfully updated ${result.data.successful} products`, 'success');
                        if (result.data.failed > 0) {
                            this.showAlert(`${result.data.failed} updates failed`, 'warning');
                        }
                        this.clearAll();
                        await this.loadProducts();
                    } else {
                        throw new Error(result.message);
                    }
                } catch (error) {
                    console.error('Error updating inventory:', error);
                    this.showAlert('Error updating inventory: ' + error.message, 'danger');
                } finally {
                    this.hideLoadingOverlay();
                }
            }

            filterProducts() {
                const cooperative = document.getElementById('cooperative-filter').value;
                const category = document.getElementById('category-filter').value;
                const status = document.getElementById('stock-status-filter').value;

                // This is a simple client-side filter
                // In production, you might want to do server-side filtering for better performance
                this.renderProductsTable();
            }

            exportTemplate() {
                const csv = 'product_id,product_name,current_quantity,new_quantity,reason\n' +
                    this.products.map(p =>
                        `${p.product_id},"${p.name}",${p.quantity_on_hand},,Bulk Update`
                    ).join('\n');

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'highland_fresh_inventory_template.csv';
                a.click();
                window.URL.revokeObjectURL(url);
            }

            showImportModal() {
                const modal = new bootstrap.Modal(document.getElementById('csvImportModal'));
                modal.show();
            }

            previewCSV(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const csv = e.target.result;
                    const lines = csv.split('\n');
                    const headers = lines[0].split(',');

                    let previewHtml = '<thead><tr>';
                    headers.forEach(header => {
                        previewHtml += `<th>${header.trim()}</th>`;
                    });
                    previewHtml += '</tr></thead><tbody>';

                    // Show first 5 rows as preview
                    for (let i = 1; i < Math.min(6, lines.length); i++) {
                        if (lines[i].trim()) {
                            previewHtml += '<tr>';
                            lines[i].split(',').forEach(cell => {
                                previewHtml += `<td>${cell.trim()}</td>`;
                            });
                            previewHtml += '</tr>';
                        }
                    }
                    previewHtml += '</tbody>';

                    document.getElementById('csv-preview-table').innerHTML = previewHtml;
                    document.getElementById('csv-preview').style.display = 'block';
                    document.getElementById('process-csv').disabled = false;
                };
                reader.readAsText(file);
            }

            async processCSVImport() {
                // Implementation for CSV import processing
                this.showAlert('CSV import feature coming soon!', 'info');
            }

            showLoadingOverlay() {
                document.getElementById('loading-indicator').style.display = 'flex';
            }

            hideLoadingOverlay() {
                document.getElementById('loading-indicator').style.display = 'none';
            }

            showAlert(message, type) {
                const alertContainer = document.getElementById('alert-container');
                const alertId = 'alert-' + Date.now();

                alertContainer.innerHTML = `
                    <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show">
                        <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'x-circle'} me-2"></i>
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;

                // Auto dismiss after 5 seconds
                setTimeout(() => {
                    const alert = document.getElementById(alertId);
                    if (alert) {
                        const bsAlert = bootstrap.Alert.getOrCreateInstance(alert);
                        bsAlert.close();
                    }
                }, 5000);
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function () {
            // Check authentication
            if (!isAuthenticated()) {
                window.location.href = 'login.html';
                return;
            }

            // Check role authorization
            if (!hasRole('Warehouse Staff') && !hasRole('Admin')) {
                alert('Access denied. Warehouse Staff or Administrator access required.');
                window.location.href = 'login.html';
                return;
            }

            // Initialize user display
            initializeUserDisplay();

            // Initialize bulk manager
            window.bulkManager = new BulkInventoryManager();
            window.bulkManager.init();
        });

        function logout() {
            if (typeof window.authLogout === 'function') {
                window.authLogout();
            } else {
                sessionStorage.clear();
                localStorage.clear();
                window.location.href = 'login.html';
            }
        }
    </script>
</body>

</html>